<script type="module">
import * as THREE from "https://cdn.skypack.dev/three@0.152.2";
import { GLTFLoader } from "https://cdn.skypack.dev/three@0.152.2/examples/jsm/loaders/GLTFLoader.js";
import { VRMLoaderPlugin } from "https://cdn.skypack.dev/@pixiv/three-vrm@1.0.0";

let currentVrm;

const container = document.getElementById("avatar-container");

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  35,
  container.clientWidth / container.clientHeight,
  0.1,
  1000
);
camera.position.set(0, 1.4, 2);

const renderer = new THREE.WebGLRenderer({ alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(1, 1, 1);
scene.add(light);

const loader = new GLTFLoader();
loader.register((parser) => new VRMLoaderPlugin(parser));

loader.load("./assets/doctor.vrm", (gltf) => {
  const vrm = gltf.userData.vrm;
  currentVrm = vrm;
  scene.add(vrm.scene);
});

function animate() {
  requestAnimationFrame(animate);

  if (currentVrm) {

  currentVrm.update(0.016)

  if (speaking) {
    const open = 0.4 + Math.random() * 0.3
    currentVrm.expressionManager.setValue('aa', open)
  } else {
    currentVrm.expressionManager.setValue('aa', 0)
  }

}

  renderer.render(scene, camera);
}

animate();
document.getElementById('speak-btn').addEventListener('click', () => {
  speak("This is a test of the virtual nutrition doctor speaking.")
})
</script>